<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Model Tools Suite</title>
  <style>
    :root {
      --primary: #c62828; /* Red */
      --secondary: #fdfdfd; /* Off-white for content */
      --text-color: #1e1e1e;
      --card-bg: #ffffff;
      --border-color: #d1d5db;
      --shadow: 0 44px 12px rgba(0, 0, 0, 0.08);
      --radius: 12px;
      --btn-blue: #2e7d32; /* Green */
      --btn-green: #4caf50;
      --btn-red: #e53935;
      --btn-gray: #9e9e9e;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0;
      width: 100%;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      /* Stable Christmas Bokeh Background */
      background: #fdfdfd url('https://upload.wikimedia.org/wikipedia/commons/e/e6/Christmas_Lights_Bokeh.jpg') no-repeat center center fixed; 
      background-size: cover;
      color: var(--text-color);
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      min-height: 100vh;
    }
    h1, h2 { text-align: center; color: var(--primary); text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8); }
    textarea, select, input[type="datetime-local"], input[type="date"], button {
      width: 100%; padding: 0.75rem; font-size: 1rem;
      margin-top: 1rem; border-radius: var(--radius);
      border: 1px solid var(--border-color);
    }
    textarea { min-height: 120px; resize: vertical; }
    /* General button style (resetting margins for compact layout) */
    .btn {
      color: white; border: none;
      margin: 0; 
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-weight: 600;
    }
    /* Margin adjustments for buttons not directly inside flow */
    .btn-flow { margin-top: 1rem; }
    .btn-blue { background-color: var(--btn-blue); }
    .btn-blue:hover { background-color: #1b5e20; }
    .btn-green { background-color: var(--btn-green); }
    .btn-green:hover { background-color: #3e8e41; }
    .btn-red { background-color: var(--btn-red); }
    .btn-red:hover { background-color: #c62828; }
    .btn-gray { background-color: var(--btn-gray); }
    .btn-gray:hover { background-color: #757575; }
    .tool-block {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      background-color: rgba(255, 255, 255, 0.95);
    }
    .output-box {
      background: #f9fafb; /* Slightly different background for output */
      padding: 1rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      font-family: 'Courier New', Courier, monospace;
      font-size: 1.1rem;
      font-weight: 600;
      margin-top: 1rem;
      white-space: pre-wrap;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.04);
      cursor: pointer;
    }
    label {
        font-weight: 600;
        display: inline-block;
        margin-top: 1rem;
    }
    .output-container {
        margin-top: 1.5rem;
        border-top: 2px solid var(--border-color); 
        padding-top: 1rem;
    }
    .clear-btn-container {
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 2px solid var(--border-color);
    }
    .hidden { display: none !important; }
    
    /* --- Multi-Quarter Styles (Minimized) --- */
    .minimal-output-grid {
        display: flex;
        justify-content: space-around;
        gap: 0.5rem; /* Reduced gap */
        margin-top: 1.5rem; /* Reduced margin */
        padding-top: 1rem; /* Reduced padding */
        border-top: 2px solid var(--primary);
        flex-wrap: wrap; /* Allows wrapping on very small screens */
    }
    .minimal-output-grid > div {
        flex: 1;
        text-align: center;
        min-width: 20%; /* Setting a lower min-width for better shrinkage */
    }
    .minimal-output-grid h4 {
        margin: 0 0 0.25rem 0; /* Reduced margin */
        font-size: 1rem; /* Reduced font size */
        color: var(--primary);
    }
    .minimal-box {
      background: #e0e0e0;
      padding: 0.75rem 0.25rem; /* Reduced padding */
      border-radius: var(--radius);
      font-family: 'Courier New', Courier, monospace;
      font-size: 1.1rem; /* Reduced font size */
      font-weight: 700;
      white-space: normal; 
      word-break: break-all;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      cursor: pointer;
     }

    /* Total Net Container (Re-added and minimized) */
    .total-net-container {
        margin-top: 1.5rem;
        text-align: center;
        width: 100%;
        padding: 0.75rem; /* Slightly reduced padding */
        border: 2px solid var(--btn-green);
        border-radius: var(--radius);
        background-color: #f1f8e9; /* Very light green background */
    }
    .total-net-container h4 {
        color: var(--btn-green); 
        font-size: 1.25rem; /* Slightly reduced font size */
        margin-top: 0;
        margin-bottom: 0.5rem; /* Slightly reduced margin */
    }
    .total-minimal-box {
        background: #ccff90; /* Light green background */
        box-shadow: 0 0 8px rgba(0, 150, 0, 0.4);
        font-size: 1.4rem; /* Slightly reduced font size */
        padding: 0.75rem 0.5rem; /* Slightly reduced padding */
        font-weight: 800;
        height: auto;
        display: block; 
    }
    
    /* Detailed Table & Inputs (Original Styles Maintained) */
    .detailed-table-container {
        margin-top: 2rem;
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        background: #f9fafb;
    }
    .detailed-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    .detailed-table th, .detailed-table td {
        padding: 0.75rem;
        text-align: right;
        border: 1px solid #e5e7eb;
        font-family: 'Courier New', Courier, monospace;
    }
    .detailed-table th:first-child, .detailed-table td:first-child {
        text-align: left;
        font-weight: 600;
        font-family: 'Segoe UI', sans-serif;
        color: var(--primary);
    }
    .detailed-table thead th {
        background-color: #f3f4f6;
        color: var(--text-color);
        font-weight: 700;
        text-align: center;
    }
    .quarter-inputs {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-top: 0.5rem;
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        background-color: #f5f5f5;
    }
    .quarter-inputs input[type="datetime-local"] {
        margin-top: 0.25rem;
        padding: 0.5rem;
        font-size: 0.9rem;
    }
    .quarter-section { padding-right: 1rem; }
    .quarter-section:nth-child(odd):not(:last-child) { border-right: 1px dashed var(--border-color); }
    .quarter-section:nth-child(3) { border-top: 1px dashed var(--border-color); padding-top: 1rem;}
    .quarter-section:nth-child(4) { border-top: 1px dashed var(--border-color); padding-top: 1rem; padding-left: 1rem;}
    .quarter-section:nth-child(2) { padding-left: 1rem;}
    .quarter-section h4 { font-weight: 700; color: var(--primary); margin: 0; }
  </style>
</head>
<body>
  <h1>Model Tools Suite üéÑ</h1>

  <div style="display:flex; gap:1rem; justify-content:center; flex-wrap:wrap; margin-top:-1rem;">
    <a href="https://model-aligner.vercel.app/" target="_blank" rel="noopener noreferrer">
      <button class="btn btn-blue">Open Model Aligner</button>
    </a>
    <a href="https://admin-admin-lma.vercel.app/" target="_blank" rel="noopener noreferrer">
      <button class="btn btn-red">Open Old Calculator</button>
    </a>
  </div>

  <div class="tool-block" id="singleQuarterBlock">
    <h2>Net Calculator (<span id="secretFTrigger" style="cursor: pointer;">F</span>iltered by Time)</h2>

    <label for="startDateTime"><strong>Start Time:</strong></label>
    <input type="datetime-local" id="startDateTime" />

    <label for="endDateTime"><strong>End Time:</strong></label>
    <input type="datetime-local" id="endDateTime" />

    <label for="logInputSingle">Paste Logs (Single-Quarter):</label>
    <textarea id="logInputSingle" placeholder="Paste logs here..."></textarea>

    <button class="btn btn-green btn-flow" id="calculateButton" onclick="calculateAndCopy()">Calculate & Copy Box 1</button>

    <div class="output-container">
        <button class="btn btn-blue btn-flow" onclick="copyToClipboard('timeFilteredResult')">Copy (Default - Excl. ALL .99)</button>
        <div id="timeFilteredResult" class="output-box" onclick="copyToClipboard('timeFilteredResult')">0.00</div>
    </div>
    <div class="output-container">
        <button class="btn btn-gray btn-flow" onclick="copyToClipboard('timeFilteredResultNo88')">Copy (Excl. ALL .99 & .88) - Lauren</button>
        <div id="timeFilteredResultNo88" class="output-box" onclick="copyToClipboard('timeFilteredResultNo88')">0.00</div>
    </div>
    <div class="output-container">
        <button class="btn btn-gray btn-flow" onclick="copyToClipboard('timeFilteredResultBox3')">Copy (Original - Excl. .99 < 100)</button>
        <div id="timeFilteredResultBox3" class="output-box" onclick="copyToClipboard('timeFilteredResultBox3')">0.00</div>
    </div>

    <div class="clear-btn-container">
        <button class="btn btn-red btn-flow" onclick="clearAllSingleQuarter()">Clear All Inputs and Results</button>
    </div>
  </div>

  <div class="tool-block" id="multiQuarterBlock" style="display: none; margin-top: 2rem;">
    <h2>Multi-<span id="secretQTrigger" style="cursor: pointer;">Q</span>uarter Tools üõ†Ô∏è</h2>

    <div style="margin-top: 1rem; text-align: center; background-color: #e0f2f1; padding: 1rem; border-radius: 8px;">
      <label for="baseDateInput" style="display: block; font-size: 1.1rem; color: #00796b; font-weight: 700; margin-top: 0;">1. Select Base Date for Shifts:</label>
      <input type="date" id="baseDateInput" style="width: 50%; max-width: 200px; margin-top: 0.5rem; display: inline-block;" />
    </div>

    <div style="margin-top: 1rem; margin-bottom: 1rem;">
      <label for="timePresetSelect" style="display: block; font-size: 1.1rem; font-weight: 700; margin-top: 0.5rem;">2. Load Shift Presets (2-Hour Blocks):</label>
      <select id="timePresetSelect" onchange="loadPresets(this.value)" style="margin-top: 0.25rem;">
        <option value="">-- Select a Shift Pattern --</option>
        <option value="bst-shift1">BST - Shift 1 (5:01AM - 1:00PM)</option>
        <option value="bst-shift2">BST - Shift 2 (1:01PM - 9:00PM)</option>
        <option value="bst-shift3">BST - Shift 3 (9:01PM - 5:00AM)</option>
        <option value="pht-shift1">PHT - Shift 1 (1:01PM - 9:00PM)</option>
        <option value="pht-shift2">PHT - Shift 2 (9:01PM - 5:00AM)</option>
        <option value="pht-shift3">PHT - Shift 3 (5:01AM - 1:00PM)</option>
      </select>
    </div>
    
    <label for="logInputMulti">Paste Logs (Multi-Quarter):</label>
    <textarea id="logInputMulti" placeholder="Paste logs here..."></textarea>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
      <label style="margin-top: 0;"><strong>Define 4 Time Quarters:</strong></label>
      <button class="btn btn-gray" id="toggleQuartersBtn" onclick="toggleQuarterInputs()" style="width: auto; padding: 0.5rem 1rem; margin-top: 0; font-size: 0.9rem;">Hide Dates</button>
    </div>

    <div id="quarterInputContainer" class="quarter-inputs">
      <div class="quarter-section">
        <h4 style="color: #007bff;">Quarter 1</h4>
        <label for="q1StartDateTime">Start:</label>
        <input type="datetime-local" id="q1StartDateTime" />
        <label for="q1EndDateTime">End:</label>
        <input type="datetime-local" id="q1EndDateTime" />
      </div>
      <div class="quarter-section">
        <h4 style="color: #ffc107;">Quarter 2</h4>
        <label for="q2StartDateTime">Start:</label>
        <input type="datetime-local" id="q2StartDateTime" />
        <label for="q2EndDateTime">End:</label>
        <input type="datetime-local" id="q2EndDateTime" />
      </div>
      <div class="quarter-section">
        <h4 style="color: #17a2b8;">Quarter 3</h4>
        <label for="q3StartDateTime">Start:</label>
        <input type="datetime-local" id="q3StartDateTime" />
        <label for="q3EndDateTime">End:</label>
        <input type="datetime-local" id="q3EndDateTime" />
      </div>
      <div class="quarter-section">
        <h4 style="color: #dc3545;">Quarter 4</h4>
        <label for="q4StartDateTime">Start:</label>
        <input type="datetime-local" id="q4StartDateTime" />
        <label for="q4EndDateTime">End:</label>
        <input type="datetime-local" id="q4EndDateTime" />
      </div>
    </div>

    <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1.5rem; align-items: center;">
      <button class="btn btn-green btn-flow" id="calculateMultiButton" onclick="calculateAndCopySelected()"
        style="padding: 1rem; width: 70%; max-width: 400px; font-size: 1.15rem;">
        Calculate All & Copy Selected
      </button>
      <div style="width: 70%; max-width: 400px;">
        <label style="margin-top: 0; display: block; text-align: center; font-size: 0.95rem; font-weight: 500;">Select Quarter Net to Copy:</label>
        <select id="copyQuarterSelect" style="margin-top: 0.25rem; padding: 1rem 0.5rem; font-size: 1.25rem; text-align: center;">
          <option value="q1">Q1</option>
          <option value="q2">Q2</option>
          <option value="q3">Q3</option>
          <option value="q4">Q4</option>
        </select>
      </div>
    </div>

    <div class="minimal-output-grid">
      <div>
        <h4>Q1</h4>
        <div id="q1TimeFilteredResult" class="minimal-box" onclick="copyToClipboard('q1TimeFilteredResult')">0.00</div>
      </div>
      <div>
        <h4>Q2</h4>
        <div id="q2TimeFilteredResult" class="minimal-box" onclick="copyToClipboard('q2TimeFilteredResult')">0.00</div>
      </div>
      <div>
        <h4>Q3</h4>
        <div id="q3TimeFilteredResult" class="minimal-box" onclick="copyToClipboard('q3TimeFilteredResult')">0.00</div>
      </div>
      <div>
        <h4>Q4</h4>
        <div id="q4TimeFilteredResult" class="minimal-box" onclick="copyToClipboard('q4TimeFilteredResult')">0.00</div>
      </div>
    </div>
    
    <div class="total-net-container">
        <h4>TOTAL NET</h4>
        <div id="totalNetResult" class="minimal-box total-minimal-box" onclick="copyToClipboard('totalNetResult')">0.00</div>
    </div>
    <div class="detailed-table-container">
      <button class="btn btn-gray btn-flow" onclick="toggleDetailedTable()">Toggle Detailed Results (Box 2 & 3)</button>
      <div id="detailedTable" class="hidden">
        <table class="detailed-table">
          <thead>
            <tr>
              <th>Calculation Type</th>
              <th style="color: #007bff;">Q1</th>
              <th style="color: #ffc107;">Q2</th>
              <th style="color: #17a2b8;">Q3</th>
              <th style="color: #dc3545;">Q4</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>**Box 1 (Default: Excl. ALL .99)**</td>
              <td id="q1TableResult">0.00</td>
              <td id="q2TableResult">0.00</td>
              <td id="q3TableResult">0.00</td>
              <td id="q4TableResult">0.00</td>
            </tr>
            <tr>
              <td>Box 2 (Strict: Excl. ALL .99 & .88)</td>
              <td id="q1TimeFilteredResultNo88">0.00</td>
              <td id="q2TimeFilteredResultNo88">0.00</td>
              <td id="q3TimeFilteredResultNo88">0.00</td>
              <td id="q4TimeFilteredResultNo88">0.00</td>
            </tr>
            <tr>
              <td>Box 3 (Original: Excl. .99 < $100)</td>
              <td id="q1TimeFilteredResultBox3">0.00</td>
              <td id="q2TimeFilteredResultBox3">0.00</td>
              <td id="q3TimeFilteredResultBox3">0.00</td>
              <td id="q4TimeFilteredResultBox3">0.00</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="clear-btn-container">
        <button class="btn btn-red btn-flow" onclick="clearAllMultiQuarter()">Clear All Multi-Quarter Inputs & Results</button>
        <button class="btn btn-gray btn-flow" onclick="toggleMultiQuarterMode()">Hide Multi-Quarter Tools</button>
    </div>
  </div>

  <script>
    const QUARTERS = ['q1', 'q2', 'q3', 'q4'];
    const LOG_ID_SINGLE = "logInputSingle";
    const LOG_ID_MULTI = "logInputMulti";
    const REQUIRED_CLICKS = 4;
    let clickCountF = 0;
    let clickCountQ = 0;

    // --- Shift Preset Data (Time Definitions Only) ---
    // Time defined as [Start Hour, Start Minute, End Hour, End Minute] (24-hour format)
    const SHIFT_PRESETS = {
        "bst-shift1": [
            [5, 1, 7, 0],   // Q1: 05:01 - 07:00
            [7, 1, 9, 0],   // Q2: 07:01 - 09:00
            [9, 1, 11, 0],  // Q3: 09:01 - 11:00
            [11, 1, 13, 0]  // Q4: 11:01 - 13:00 (1:00PM)
        ],
        "bst-shift2": [
            [13, 1, 15, 0], // Q1: 13:01 - 15:00 (1:01PM - 3:00PM)
            [15, 1, 17, 0], // Q2: 15:01 - 17:00 (3:01PM - 5:00PM)
            [17, 1, 19, 0], // Q3: 17:01 - 19:00 (5:01PM - 7:00PM)
            [19, 1, 21, 0]  // Q4: 19:01 - 21:00 (7:01PM - 9:00PM)
        ],
        "bst-shift3": [
            [21, 1, 23, 0], // Q1: 21:01 - 23:00 (9:01PM - 11:00PM)
            [23, 1, 1, 0],  // Q2: 23:01 - 01:00 (11:01PM - 1:00AM)
            [1, 1, 3, 0],   // Q3: 01:01 - 03:00 (1:01AM - 3:00AM)
            [3, 1, 5, 0]    // Q4: 03:01 - 05:00 (3:01AM - 5:00AM)
        ],
        "pht-shift1": [
            [13, 1, 15, 0], // Q1: 1:01PM - 3:00PM
            [15, 1, 17, 0], // Q2: 3:01PM - 5:00PM
            [17, 1, 19, 0], // Q3: 5:01PM - 7:00PM
            [19, 1, 21, 0]  // Q4: 7:01PM - 9:00PM
        ],
        "pht-shift2": [
            [21, 1, 23, 0], // Q1: 9:01PM - 11:00PM
            [23, 1, 1, 0],  // Q2: 11:01PM - 1:00AM (Next Day)
            [1, 1, 3, 0],   // Q3: 1:01AM - 3:00AM (Next Day)
            [3, 1, 5, 0]    // Q4: 3:01AM - 5:00AM (Next Day)
        ],
        "pht-shift3": [
            [5, 1, 7, 0],   // Q1: 5:01AM - 7:00AM (Next Day)
            [7, 1, 9, 0],   // Q2: 7:01AM - 9:00AM (Next Day)
            [9, 1, 11, 0],  // Q3: 9:01AM - 11:00AM (Next Day)
            [11, 1, 13, 0]  // Q4: 11:01AM - 1:00PM (Next Day)
        ]
    };


    // --- Shared Helper Functions ---
    // Helper to get a date object from a quarter/type pair ID
    function getDate(quarter, type) {
      const input = document.getElementById(`${quarter}${type}DateTime`);
      if (!input || !input.value) return null;
      return new Date(input.value);
    }

    // Function to parse the date from the log line
    function parseDate(line) {
      const match = line.match(/([A-Za-z]{2,}) (\d{1,2}),\s*(\d{4}),\s*(\d{1,2}):(\d{2})\s*(am|pm)/i);
      if (!match) return null;

      const [ , monthStr, day, year, hourStr, minuteStr, ampm ] = match;
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

      function levenshtein(a, b) {
        const dp = Array.from({length: b.length + 1}, (_, i) => [i]);
        dp[0] = Array.from({length: a.length + 1}, (_, j) => j);
        for (let i = 1; i <= b.length; i++) {
          for (let j = 1; j <= a.length; j++) {
            dp[i][j] = b[i - 1] === a[j - 1]
              ? dp[i - 1][j - 1]
              : Math.min(dp[i - 1][j - 1], dp[i][j - 1], dp[i - 1][j]) + 1;
          }
        }
        return dp[b.length][a.length];
      }

      function getClosestMonthIndex(input) {
        input = input.toLowerCase();
        let bestIndex = -1;
        let bestScore = Infinity;
        months.forEach((mon, idx) => {
          const score = levenshtein(input, mon.toLowerCase());
          if (score < bestScore) {
            bestScore = score;
            bestIndex = idx;
          }
        });
        return bestScore <= 2 ? bestIndex : -1;
      }

      const monthIndex = getClosestMonthIndex(monthStr);
      if (monthIndex === -1) return null;

      let hour = parseInt(hourStr);
      const minute = parseInt(minuteStr);

      if (ampm.toLowerCase() === "pm" && hour !== 12) hour += 12;
      if (ampm.toLowerCase() === "am" && hour === 12) hour = 0; // 12 AM is 00:00

      return new Date(parseInt(year), monthIndex, parseInt(day), hour, minute);
    }
    
    // Helper function to format a Date object into the required 'YYYY-MM-DDThh:mm' format
    function formatDateTimeLocal(date) {
        if (!date || isNaN(date)) return "";
        const y = date.getFullYear();
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const d = date.getDate().toString().padStart(2, '0');
        const h = date.getHours().toString().padStart(2, '0');
        const min = date.getMinutes().toString().padStart(2, '0');
        return `${y}-${m}-${d}T${h}:${min}`;
    }


    function copyToClipboard(id) {
      const text = document.getElementById(id).textContent.trim();
      // Use the clipboard API
      if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(() => {
              // Optional: Add a visual cue
              const el = document.getElementById(id);
              const originalColor = el.style.backgroundColor;
              
              const isTotal = id === 'totalNetResult';
              
              if (isTotal) {
                el.style.backgroundColor = '#a5d6a7'; // Darker green for total copy
              } else {
                el.style.backgroundColor = '#d1e7dd'; 
              }
              
              setTimeout(() => { el.style.backgroundColor = originalColor; }, 300);
          }).catch(err => {
              console.error('Failed to copy text: ', err);
              fallbackCopyTextToClipboard(text);
           });
      } else {
          fallbackCopyTextToClipboard(text);
       }
    }
    // Fallback for non-navigator.clipboard environments
    function fallbackCopyTextToClipboard(text) {
        var textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position="fixed";
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.width = "2em";
        textArea.style.height = "2em";
        textArea.style.padding = "0";
        textArea.style.border = "none";
        textArea.style.outline = "none";
        textArea.style.boxShadow = "none";
        textArea.style.background = "transparent";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
        }
        document.body.removeChild(textArea);
    }
    // --- Single-Quarter Logic (Original) ---
    function calculateNetSingleQuarter(showAlerts = false) {
      const logLines = document.getElementById(LOG_ID_SINGLE).value.trim().split("\n");
      const start = getDate("start", ""); 
      const end = getDate("end", "");

      if (!start || !end) {
          if (showAlerts) alert("Please select both a Start Time and an End Time for the single-quarter tool.");
          console.error("Please select both a Start Time and an End Time.");
          return false;
      }
      if (start > end) {
          if (showAlerts) alert("Start Time must be before End Time.");
          console.error("Start Time must be before End Time.");
          return false;
      }

      let totalBox1 = 0;         
      let totalBox2 = 0;         
      let totalBox3 = 0;   

      for (let i = 0; i < logLines.length; i++) {
        const date = parseDate(logLines[i]);

        if (date && date >= start && date <= end) {
          const grossLine = logLines[i + 1];
          const netLine = logLines[i + 3];

          const grossMatch = grossLine?.match(/\$(\d+\.\d{2})/);
          const netMatch = netLine?.match(/\$(\d+\.\d{2})$/);

          if (grossMatch && netMatch) {
            const gross = parseFloat(grossMatch[1]);
            const net = parseFloat(netMatch[1]);

            const is99 = gross.toFixed(2).endsWith(".99");
            const is88 = gross.toFixed(2).endsWith(".88");
            const under100 = gross < 100;

            if (!is99) {
              totalBox1 += net;
            }

            if (!is99 && !is88) {
              totalBox2 += net;
            }

            if (!(is99 && under100)) {
              totalBox3 += net;
            }
          }
        }
      }

      document.getElementById("timeFilteredResult").textContent = totalBox1.toFixed(2);
      document.getElementById("timeFilteredResultNo88").textContent = totalBox2.toFixed(2);
      document.getElementById("timeFilteredResultBox3").textContent = totalBox3.toFixed(2);

      return true;
    }
    function calculateAndCopy() {
        const success = calculateNetSingleQuarter(true);
        if (success) {
            copyToClipboard('timeFilteredResult');
        }
    }
    function clearAllSingleQuarter() {
      document.getElementById(LOG_ID_SINGLE).value = "";
      document.getElementById("startDateTime").value = "";
      document.getElementById("endDateTime").value = "";
      document.getElementById("timeFilteredResult").textContent = "0.00";
      document.getElementById("timeFilteredResultNo88").textContent = "0.00";
      document.getElementById("timeFilteredResultBox3").textContent = "0.00";
    }

    // --- Multi-Quarter Preset Logic (UPDATED FOR PHT) ---

    // Helper function to clear *only* the quarter date inputs
    function clearAllQuarterInputs() {
        QUARTERS.forEach(q => {
            document.getElementById(`${q}StartDateTime`).value = "";
            document.getElementById(`${q}EndDateTime`).value = "";
        });
    }

    function loadPresets(presetKey) {
        const baseDateInput = document.getElementById('baseDateInput');
        const baseDateStr = baseDateInput.value;
        
        if (!baseDateStr) {
            alert("Please select a Base Date first before choosing a Shift Pattern!");
            clearAllQuarterInputs();
            document.getElementById('timePresetSelect').value = "";
            return;
        }
        if (!presetKey) {
            clearAllQuarterInputs();
            return;
        }

        const baseDate = new Date(baseDateStr); 

        if (isNaN(baseDate)) {
            alert("Invalid Base Date selected.");
            document.getElementById('timePresetSelect').value = "";
            clearAllQuarterInputs();
            return;
        }
        baseDate.setHours(0, 0, 0, 0); // Normalize to start of day

        const preset = SHIFT_PRESETS[presetKey];
        const isPHT = presetKey.startsWith('pht');

        QUARTERS.forEach((q, index) => {
            const [startH, startM, endH, endM] = preset[index];

            // Start with the base date
            let startDate = new Date(baseDate);
            let endDate = new Date(baseDate);

            // Set the quarter times on the base date
            startDate.setHours(startH, startM, 0, 0);
            endDate.setHours(endH, endM, 0, 0);

            // --- Day Rollover Logic ---
            
            // 1. Check for crossover within the quarter itself (e.g., 23:01 to 01:00)
            if (endH < startH) {
                 endDate.setDate(endDate.getDate() + 1);
            }

            // 2. Adjustments specific to PHT Shifts: PHT shifts are calculated relative to the BST equivalent
            // PHT Shift 2 (9:01 PM - 5:00 AM) and PHT Shift 3 (5:01 AM - 1:00 PM) cross the Base Date.

            if (isPHT) {
                if (presetKey === 'pht-shift2') {
                    // Q1 (9:01PM - 11:00PM) is on the base date.
                    // Q2, Q3, Q4 start on the base date but end the next day, or start/end entirely on the next day.
                    
                    if (index >= 1) { // Q2 (index 1) has 23:01 start, which is handled by endH < startH for end date.
                       // Q3 and Q4 start/end entirely on the next day relative to the *shift*.
                    }
                    
                    // The standard rollover logic handles Q2.
                    // Q3 and Q4 (1:01 AM onwards) are entirely on the next day relative to the Base Date.
                    if (index >= 2) { 
                        startDate.setDate(startDate.getDate() + 1);
                        endDate.setDate(endDate.getDate() + 1);
                    }
                } else if (presetKey === 'pht-shift3') {
                    // All quarters in PHT Shift 3 (5:01 AM - 1:00 PM) start and end on the day *after* the base date.
                    startDate.setDate(startDate.getDate() + 1);
                    endDate.setDate(endDate.getDate() + 1);
                }
            } 
            // --- Day Rollover Logic End ---

            // 3. Apply to Inputs
            document.getElementById(`${q}StartDateTime`).value = formatDateTimeLocal(startDate);
            document.getElementById(`${q}EndDateTime`).value = formatDateTimeLocal(endDate);
        });
    }


    // --- Multi-Quarter Calculation and Clear Logic (Updated to include Grand Total) ---
    function calculateNetMultiQuarter(showAlerts = false) {
      const logLines = document.getElementById(LOG_ID_MULTI).value.trim().split("\n");

      const quarterRanges = {};
      let hasValidRange = false;

      QUARTERS.forEach(q => {
          const start = getDate(q, 'Start');
          const end = getDate(q, 'End');

          quarterRanges[q] = { start: null, end: null, valid: false };

          if (start && end) {
              if (start <= end) {
                  quarterRanges[q].start = start;
                  quarterRanges[q].end = end;
                  quarterRanges[q].valid = true;
                  hasValidRange = true;
              } else {
                   console.error(`Error in ${q}: Start Time must be before End Time.`);
              }
          }
      });

      if (!hasValidRange) {
          if (showAlerts) {
            alert("Please set valid Start and End times for at least one Quarter in the Multi-Quarter tool.");
          }
          return false;
      }

      const allQuarterTotals = {
        q1: { box1: 0, box2: 0, box3: 0 },
        q2: { box1: 0, box2: 0, box3: 0 },
        q3: { box1: 0, box2: 0, box3: 0 },
        q4: { box1: 0, box2: 0, box3: 0 },
      };
      
      let grandTotalBox1 = 0; // Initialize grand total

      for (let i = 0; i < logLines.length; i++) {
        const date = parseDate(logLines[i]);

        let targetQuarter = null;

        if (date) {
            for (const q of QUARTERS) {
                const range = quarterRanges[q];
                if (range.valid && date >= range.start && date <= range.end) {
                    targetQuarter = q;
                    break;
                }
            }
        }

        if (targetQuarter) {
          const grossLine = logLines[i + 1];
          const netLine = logLines[i + 3];

          const grossMatch = grossLine?.match(/\$(\d+\.\d{2})/);
          const netMatch = netLine?.match(/\$(\d+\.\d{2})$/);

          if (grossMatch && netMatch) {
            const gross = parseFloat(grossMatch[1]);
            const net = parseFloat(netMatch[1]);

            const is99 = gross.toFixed(2).endsWith(".99");
            const is88 = gross.toFixed(2).endsWith(".88");
            const under100 = gross < 100;

            const totals = allQuarterTotals[targetQuarter];

            if (!is99) {
              totals.box1 += net;
            }

            if (!is99 && !is88) {
              totals.box2 += net;
            }

            if (!(is99 && under100)) {
              totals.box3 += net;
            }
          }
        }
      }

      QUARTERS.forEach(q => {
          const totals = allQuarterTotals[q];
          
          grandTotalBox1 += totals.box1; // Accumulate grand total for Box 1

          document.getElementById(`${q}TimeFilteredResult`).textContent = totals.box1.toFixed(2);
          document.getElementById(`${q}TableResult`).textContent = totals.box1.toFixed(2);
          document.getElementById(`${q}TimeFilteredResultNo88`).textContent = totals.box2.toFixed(2);
          document.getElementById(`${q}TimeFilteredResultBox3`).textContent = totals.box3.toFixed(2);
      });
      
      // Update the TOTAL box
      document.getElementById('totalNetResult').textContent = grandTotalBox1.toFixed(2);

      return true;
    }

    function calculateAndCopySelected() {
      const calculationSuccessful = calculateNetMultiQuarter(true); 

      if (!calculationSuccessful) return;

      const select = document.getElementById('copyQuarterSelect');
      const quarter = select.value;

      const elementId = `${quarter}TimeFilteredResult`;

      setTimeout(() => {
          const resultText = document.getElementById(elementId).textContent.trim();

          if (resultText === '0.00') {
              alert(`Calculation completed, but the result for ${select.options[select.selectedIndex].text} is 0.00. Please check your logs/inputs. Nothing was copied.`);
              return;
          }

          copyToClipboard(elementId);
      }, 50);
    }
    function toggleDetailedTable() {
      const table = document.getElementById('detailedTable');
      table.classList.toggle('hidden');
    }
    function toggleQuarterInputs() {
      const container = document.getElementById('quarterInputContainer');
      const button = document.getElementById('toggleQuartersBtn');

      container.classList.toggle('hidden');

      if (container.classList.contains('hidden')) {
          button.textContent = 'Show Dates';
          button.classList.remove('btn-gray');
          button.classList.add('btn-blue');
      } else {
          button.textContent = 'Hide Dates';
          button.classList.remove('btn-blue');
          button.classList.add('btn-gray');
       }
    }
    function clearAllMultiQuarter() {
      document.getElementById(LOG_ID_MULTI).value = ""; 
      document.getElementById('baseDateInput').value = ""; 
      document.getElementById('timePresetSelect').value = ""; 

      QUARTERS.forEach(q => {
          document.getElementById(`${q}StartDateTime`).value = "";
          document.getElementById(`${q}EndDateTime`).value = "";

          document.getElementById(`${q}TimeFilteredResult`).textContent = "0.00";
          document.getElementById(`${q}TimeFilteredResultNo88`).textContent = "0.00";
          document.getElementById(`${q}TimeFilteredResultBox3`).textContent = "0.00";
          document.getElementById(`${q}TableResult`).textContent = "0.00";
      });
      
      // Clear the Total box
      document.getElementById('totalNetResult').textContent = "0.00";
      
      document.getElementById('detailedTable').classList.add('hidden');
    }
    // --- Secret Toggle Logic ---        
    function toggleMultiQuarterMode() {
        const multi = document.getElementById('multiQuarterBlock');
        const single = document.getElementById('singleQuarterBlock'); 

        if (multi.style.display === 'none' || multi.style.display === '') {
            multi.style.display = 'block';
            single.style.display = 'none';
        } else {
            multi.style.display = 'none';
            single.style.display = 'block'; 
         }
    }
    function handleSecretFClick() {
        clickCountF++;
        if (clickCountF >= REQUIRED_CLICKS) {
            toggleMultiQuarterMode();
            clickCountF = 0;
            clickCountQ = 0;
        }
    }
    function handleSecretQClick() {
        const multi = document.getElementById('multiQuarterBlock');
        if (multi.style.display === 'block') {
            clickCountQ++;
            if (clickCountQ >= REQUIRED_CLICKS) {
                toggleMultiQuarterMode();
                clickCountQ = 0;
                clickCountF = 0;
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const triggerF = document.getElementById('secretFTrigger');
        if (triggerF) {
            triggerF.addEventListener('click', handleSecretFClick);
        }

        const triggerQ = document.getElementById('secretQTrigger');
        if (triggerQ) {
            triggerQ.addEventListener('click', handleSecretQClick);
        }
    });
  </script>
</body>
</html>
